<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Admin - Quản lý thiết bị điện tử</title>
<link rel="stylesheet" href="quanly.css">
</head>
<body>
<div class="container">
<div class="header-bar">
    <h2>Trang quản lý thiết bị điện tử (Admin)</h2>
    <div class="user-info">
        <span class="username">Xin chào, admin</span>
        <button class="btn-logout" onclick="handleLogout()">Đăng xuất</button>
    </div>
</div>

<div class="toolbar">
    <input type="text" id="searchBar" class="search-bar" placeholder="Tìm kiếm thiết bị, loại, hãng..." oninput="filterTable()">
</div>

<!-- Form thêm thiết bị - hiển thị inline -->
<div class="form-box">
    <h3>Thêm thiết bị mới</h3>
    <form id="deviceForm" onsubmit="submitDevice(event)">
        <div class="form-row">
            <div class="form-group">
                <label>Tên thiết bị</label>
                <input type="text" id="inputName" required placeholder="VD: PlayStation 5">
            </div>
            <div class="form-group">
                <label>Loại</label>
                <select id="inputType">
                    <option value="Console">Console</option>
                    <option value="Điện thoại">Điện thoại</option>
                </select>
            </div>
            <div class="form-group">
                <label>Hãng</label>
                <input type="text" id="inputBrand" required placeholder="VD: Sony, Apple">
            </div>
            <div class="form-group">
                <label>Giá (VNĐ)</label>
                <input type="number" id="inputPrice" required placeholder="VD: 15000000" min="0">
            </div>
            <div class="form-group">
                <label>Tình trạng</label>
                <select id="inputStatus">
                    <option value="Hoạt động">Hoạt động</option>
                    <option value="Hỏng">Hỏng</option>
                </select>
            </div>
            <div class="form-group form-submit">
                <label>&nbsp;</label>
                <button type="submit" class="btn-submit">+ Thêm thiết bị</button>
            </div>
        </div>
    </form>
</div>

<table id="deviceTable">
    <tr>
        <th>Tên thiết bị</th>
        <th>Loại</th>
        <th>Hãng</th>
        <th>Giá (VNĐ)</th>
        <th>Tình trạng</th>
        <th>Thao tác</th>
    </tr>
</table>
</div>

<script src="auth.js"></script>
<script src="devices.js"></script>
<script>
// Kiểm tra quyền admin - chỉ admin mới vào được
const user = requireAuth(true);
if (user) {
    document.querySelector('.username').textContent = 'Xin chào, ' + user.username;
}

function handleLogout() {
    logout();
    window.location.href = 'dangnhap.html';
}

function saveTableToStorage() {
    const table = document.getElementById("deviceTable");
    const rows = table.getElementsByTagName("tr");
    const devices = [];
    for (let i = 1; i < rows.length; i++) {
        const cells = rows[i].getElementsByTagName("td");
        if (cells.length >= 5) {
            devices.push({
                name: cells[0].innerText,
                type: cells[1].innerText,
                brand: cells[2].innerText,
                price: cells[3].innerText.replace(/\D/g, ''),
                status: cells[4].innerText
            });
        }
    }
    saveDevices(devices);
}

function loadDevicesToTable() {
    const devices = getDevices();
    const table = document.getElementById("deviceTable");
    while (table.rows.length > 1) table.deleteRow(1);
    devices.forEach(d => {
        const row = table.insertRow();
        row.insertCell(0).innerText = d.name;
        row.insertCell(1).innerText = d.type;
        row.insertCell(2).innerText = d.brand;
        row.insertCell(3).innerText = formatPrice(d.price);
        row.insertCell(4).innerText = d.status;
        const actionCell = row.insertCell(5);
        actionCell.innerHTML = `<button class="edit" onclick="editDevice(this)">Sửa</button> <button class="delete" onclick="deleteDevice(this)">Xóa</button>`;
    });
}

document.addEventListener('DOMContentLoaded', loadDevicesToTable);

function submitDevice(e) {
    e.preventDefault();
    let name = document.getElementById("inputName").value.trim();
    let type = document.getElementById("inputType").value;
    let brand = document.getElementById("inputBrand").value.trim();
    let price = document.getElementById("inputPrice").value;
    let status = document.getElementById("inputStatus").value;

    let table = document.getElementById("deviceTable");
    let row = table.insertRow();

    row.insertCell(0).innerText = name;
    row.insertCell(1).innerText = type;
    row.insertCell(2).innerText = brand;
    row.insertCell(3).innerText = formatPrice(price);
    row.insertCell(4).innerText = status;

    let actionCell = row.insertCell(5);
    actionCell.innerHTML = `
        <button class="edit" onclick="editDevice(this)">Sửa</button>
        <button class="delete" onclick="deleteDevice(this)">Xóa</button>
    `;

    document.getElementById("deviceForm").reset();
    saveTableToStorage();
}

function deleteDevice(btn) {
    if (confirm("Bạn có chắc muốn xóa thiết bị này không?")) {
        btn.parentElement.parentElement.remove();
        saveTableToStorage();
    }
}

function filterTable() {
    let query = document.getElementById("searchBar").value.toLowerCase().trim();
    let table = document.getElementById("deviceTable");
    let rows = table.getElementsByTagName("tr");

    for (let i = 1; i < rows.length; i++) {
        let row = rows[i];
        let cells = row.getElementsByTagName("td");
        let found = false;
        for (let j = 0; j < cells.length; j++) {
            if (cells[j].innerText.toLowerCase().includes(query)) {
                found = true;
                break;
            }
        }
        row.style.display = found || !query ? "" : "none";
    }
}

function editDevice(btn) {
    let row = btn.parentElement.parentElement;

    let name = prompt("Sửa tên thiết bị:", row.cells[0].innerText);
    let type = prompt("Sửa loại:", row.cells[1].innerText);
    let brand = prompt("Sửa hãng:", row.cells[2].innerText);
    let price = prompt("Sửa giá (VNĐ):", row.cells[3].innerText.replace(/\D/g,""));
    let status = prompt("Sửa tình trạng:", row.cells[4].innerText);

    if (name) row.cells[0].innerText = name;
    if (type) row.cells[1].innerText = type;
    if (brand) row.cells[2].innerText = brand;
    if (price) row.cells[3].innerText = formatPrice(price);
    if (status) row.cells[4].innerText = status;
    saveTableToStorage();
}
</script>
</body>
</html>
